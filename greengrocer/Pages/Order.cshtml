@page
@model greengrocer.Pages.OrderModel
@using greengrocer.Models
@{
    ViewData["Title"] = "Orders";
}

<div class="container mt-4">
    <div class="row">
        <!-- LEFT: NEW ORDER FORM -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Yeni Sipariş</h5>
                </div>
                <div class="card-body">
                    <form id="orderForm">
                        <div class="form-group">
                            <label asp-for="Input.OrderName" class="font-weight-bold"></label>
                            <input asp-for="Input.OrderName" class="form-control" />
                            <span asp-validation-for="Input.OrderName" class="text-danger small"></span>
                        </div>

                        <h6 class="mt-3">Order Items</h6>
                        <table class="table table-sm table-bordered mt-2">
                            <thead class="thead-light">
                                <tr>
                                    <th style="width: 60%;">Sipariş Başlığı</th>
                                    <th style="width: 40%;">Miktarı</th>
                                </tr>
                            </thead>
                            <tbody id="orderItemsBody">
                                @* If there are items after a failed post, render them *@
                                @if (Model.Input.Items != null && Model.Input.Items.Count > 0)
                                {
                                    for (int i = 0; i < Model.Input.Items.Count; i++)
                                    {
                                        <tr>
                                            <td>
                                                <input name="Input.Items[@i].Title"
                                                       value="@Model.Input.Items[i].Title"
                                                       class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <input name="Input.Items[@i].Quantity"
                                                       value="@Model.Input.Items[i].Quantity"
                                                       class="form-control form-control-sm" />
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>

                        <input type="hidden" id="itemIndex" value="@(Model.Input.Items?.Count ?? 0)" />


                        <button type="button" id="btnSaveOrder" class="btn btn-primary btn-block">Kaydet</button>

                        @if (!string.IsNullOrEmpty(Model.Message))
                        {
                            <div class="alert alert-success mt-3 mb-0 py-2">
                                @Model.Message
                            </div>
                        }
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT: EXISTING ORDERS LIST -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Sepettekiler</h5>
                </div>
                <div class="card-body p-0">
                    @if (Model.ExistingOrders == null || !Model.ExistingOrders.Any())
                    {
                        <p class="p-3 mb-0 text-muted">No orders yet.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <!-- <div id="ordersGrid" style="height: 400px;"></div>-->
                            <div id="dxOrdersGrid" style="height: 450px; background: white;"></div>


                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FRUIT STRIP -->
<section class="product-strip">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3 px-1">
            <h4 class="product-strip-title mb-0">Meyveler</h4>
            <div class="d-flex align-items-center">
                <a href="#" class="small mr-3">Tüm Ürünleri Gör</a>
                <button type="button" class="btn btn-sm btn-light border mr-1">&larr;</button>
                <button type="button" class="btn btn-sm btn-light border">&rarr;</button>
            </div>
        </div>

        <div class="row no-gutters">
            <!-- Card 1 -->
            <div class="col-6 col-md-4 col-lg-2 mb-3 pr-2">
                <div class="product-card">
                    <img src="~/images/avakado.png" class="img-fluid" alt="Avokado Yerli Adet" />
                    <div class="font-weight-bold mb-2">Avokado Yerli Adet</div>

                    <div class="product-yellow-strip">
                        İndirimli
                    </div>

                    <div class="mb-2">
                        <span class="product-price-old">49,90 TL</span>
                        <span class="product-price-new">39,90 TL</span>
                    </div>

                    <button type="button"
                            class="btn btn-cart text-white btn-block add-to-order"
                            data-title="Avokado Yerli Adet">
                        <i class="fas fa-shopping-cart"></i> Sepete Ekle
                    </button>
                </div>
            </div>

            <!-- Card 2 -->
            <div class="col-6 col-md-4 col-lg-2 mb-3 pr-2">
                <div class="product-card">
                    <img src="~/images/portakal.png" class="img-fluid" alt="Washington Portakal kg" />

                    <div class="font-weight-bold mb-2">Washington Portakal kg</div>

                    <div class="product-yellow-strip">
                        İndirimli
                    </div>

                    <div class="mb-2">
                        <span class="product-price-old">69,90 TL</span>
                        <span class="product-price-new">39,90 TL</span>
                    </div>

                    <button type="button"
                            class="btn btn-cart text-white btn-block add-to-order"
                            data-title="Washington Portakal kg">
                        <i class="fas fa-shopping-cart"></i> Sepete Ekle
                    </button>
                </div>
            </div>

            <!-- Card 3 -->
            <div class="col-6 col-md-4 col-lg-2 mb-3 pr-2">
                <div class="product-card">
                    <img src="~/images/mandalina.png" class="img-fluid" alt="Mandalina Satsuma İzmir kg" />

                    <div class="font-weight-bold mb-2">Mandalina Satsuma İzmir kg</div>

                    <div class="product-yellow-strip">
                        İndirimli
                    </div>

                    <div class="mb-2">
                        <span class="product-price-old">69,95 TL</span>
                        <span class="product-price-new">39,90 TL</span>
                    </div>

                    <button type="button"
                            class="btn btn-cart text-white btn-block add-to-order"
                            data-title="Mandalina Satsuma İzmir kg">
                        <i class="fas fa-shopping-cart"></i> Sepete Ekle
                    </button>
                </div>
            </div>

            <!-- Card 4 -->
            <div class="col-6 col-md-4 col-lg-2 mb-3 pr-2">
                <div class="product-card">
                    <img src="~/images/limon.png" class="img-fluid" alt="Limon Mayer kg" />

                    <div class="font-weight-bold mb-2">Limon Mayer kg</div>

                    <div class="product-yellow-strip">
                        İndirimli
                    </div>

                    <div class="mb-2">
                        <span class="product-price-old">79,90 TL</span>
                        <span class="product-price-new">49,90 TL</span>
                    </div>

                    <button type="button"
                            class="btn btn-cart text-white btn-block add-to-order"
                            data-title="Limon Mayer kg">
                        <i class="fas fa-shopping-cart"></i> Sepete Ekle
                    </button>
                </div>
            </div>

            <!-- Card 5 -->
            <div class="col-6 col-md-4 col-lg-2 mb-3 pr-2">
                <div class="product-card">
                    <img src="~/images/mandalina.png" class="img-fluid" alt="Mandalina Satsuma kg" />

                    <div class="font-weight-bold mb-2">Mandalina Satsuma kg</div>

                    <div class="product-yellow-strip">
                        İndirimli
                    </div>

                    <div class="mb-2">
                        <span class="product-price-old">39,90 TL</span>
                        <span class="product-price-new">24,90 TL</span>
                    </div>

                    <button type="button"
                            class="btn btn-cart text-white btn-block add-to-order"
                            data-title="Mandalina Satsuma kg">
                        <i class="fas fa-shopping-cart"></i> Sepete Ekle
                    </button>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function addItemRow(title) {
            var index = parseInt($('#itemIndex').val() || '0');

            var rowHtml =
                '<tr class="order-row">' +
                '  <td>' +
                '    <input name="Input.Items[' + index + '].Title" ' +
                '           value="' + title.replace(/"/g, '&quot;') + '" ' +
                '           class="form-control form-control-sm" />' +
                '  </td>' +
                '  <td>' +
                '    <div class="d-flex">' +
                '      <input name="Input.Items[' + index + '].Quantity" value="1" class="form-control form-control-sm mr-2" style="max-width:70px;" />' +
                '      <button type="button" class="btn btn-sm btn-danger delete-row"><i class="fas fa-trash"></i></button>' +
                '    </div>' +
                '  </td>' +
                '</tr>';

            $('#orderItemsBody').append(rowHtml);
            $('#itemIndex').val(index + 1);
        }

        $(function () {
            $('.add-to-order').on('click', function (e) {
                e.preventDefault();
                var title = $(this).data('title');
                addItemRow(title);
            });

            $('#orderItemsBody').on('click', '.delete-row', function () {
                $(this).closest('tr').remove();
                reindexRows();
            });

            function reindexRows() {
                var rows = $('#orderItemsBody tr');
                rows.each(function (i, row) {
                    $(row).find('input').each(function () {
                        var oldName = $(this).attr('name');
                        var newName = oldName.replace(/\[\d+\]/, '[' + i + ']');
                        $(this).attr('name', newName);
                    });
                });
                $('#itemIndex').val(rows.length);
            }
        });
    </script>

    <script>
        var jwtToken = null;
        var ordersGrid = null;

        function getJwtToken() {
            return $.ajax({
                url: "/api/auth/token",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({ username: "admin", password: "123456" })
            });
        }

        getJwtToken().done(function (result) {
            console.log("TOKEN:", result);
            jwtToken = result.token;

            // DevExtreme grid
            ordersGrid = $("#dxOrdersGrid").dxDataGrid({
                dataSource: DevExpress.data.AspNet.createStore({
                    key: "id",
                    loadUrl: "/api/orders",
                    onBeforeSend: function (method, ajaxOptions) {
                        ajaxOptions.headers = ajaxOptions.headers || {};
                        ajaxOptions.headers["Authorization"] = "Bearer " + jwtToken;
                        console.log("onBeforeSend →", method, ajaxOptions.headers);
                    }
                }),
                showBorders: true,
                paging: { pageSize: 10 },
                filterRow: { visible: true },
                searchPanel: { visible: true },
                sorting: { mode: "multiple" },
                columns: [
                    { dataField: "orderName", caption: "Sipariş Adı" },
                    { dataField: "totalQty", caption: "Toplam Miktar" },
                    {
                        dataField: "itemsText",
                        caption: "İçindekiler"
                    }
                ]
            }).dxDataGrid("instance");

            hookSaveButton();
        });

        function hookSaveButton() {
            $("#btnSaveOrder").on("click", function () {
                if (!jwtToken) {
                    alert("Token alınamadı, lütfen sayfayı yenileyin.");
                    return;
                }

                var payload = {
                    orderName: $("#Input_OrderName").val(),
                    items: []
                };

                $("#orderItemsBody tr").each(function () {
                    var title = $(this).find('input[name*=\".Title\"]').val();
                    var qty = parseInt($(this).find('input[name*=\".Quantity\"]').val() || "0");

                    if (title && qty > 0) {
                        payload.items.push({
                            title: title,
                            quantity: qty
                        });
                    }
                });

                if (!payload.orderName) {
                    alert("Sipariş adı boş olamaz.");
                    return;
                }

                if (payload.items.length === 0) {
                    alert("En az bir ürün eklemelisiniz.");
                    return;
                }

                console.log("POST PAYLOAD:", payload);

                $.ajax({
                    url: "/api/orders",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    headers: {
                        "Authorization": "Bearer " + jwtToken
                    }
                }).done(function (res) {
                    console.log("SAVE OK:", res);

                    if (ordersGrid) {
                        ordersGrid.refresh();
                    }

                    // Formu temizle
                    $("#Input_OrderName").val("");
                    $("#orderItemsBody").empty();
                    $("#itemIndex").val("0");

                    alert("Sipariş başarıyla kaydedildi.");
                }).fail(function (xhr) {
                    console.error("SAVE ERROR:", xhr);
                    alert("Sipariş kaydedilemedi. (Status: " + xhr.status + ")");
                });
            });
        }
    </script>
}




